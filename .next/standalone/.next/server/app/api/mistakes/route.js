"use strict";(()=>{var e={};e.id=5029,e.ids=[5029],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},33942:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>q,routeModule:()=>y,serverHooks:()=>w,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{GET:()=>m,PUT:()=>g});var i=r(49303),s=r(88716),a=r(60670),o=r(87070),u=r(75571),l=r(95456),d=r(75748),p=r(57369),c=r(5112);async function m(e){try{let t=await (0,u.getServerSession)(l.L);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.user.id,{searchParams:n}=new URL(e.url),i=n.get("category"),s=n.get("status"),a=parseInt(n.get("limit")||"20"),m=parseInt(n.get("page")||"1"),g=(m-1)*a,y={userId:r};i&&(y.category=i),s&&(y.status=s),await (0,d.Z)();let q=await p.Z.countDocuments(y),x=await p.Z.find(y).skip(g).limit(a).sort({lastWrongDate:-1}),w=x.map(e=>e.questionId),f=await c.Z.find({_id:{$in:w}}),h=x.map(e=>{let t=f.find(t=>t._id.toString()===e.questionId.toString());return{...e.toObject(),question:t||null}});return o.NextResponse.json({mistakes:h,pagination:{total:q,page:m,limit:a,totalPages:Math.ceil(q/a)}})}catch(e){return console.error("Error fetching mistakes:",e),o.NextResponse.json({error:"Failed to fetch mistakes"},{status:500})}}async function g(e){try{let t=await (0,u.getServerSession)(l.L);if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.user.id,{mistakeIds:n,status:i}=await e.json();if(!n||!Array.isArray(n)||!i)return o.NextResponse.json({error:"Missing required fields"},{status:400});await (0,d.Z)();let s=await p.Z.updateMany({_id:{$in:n},userId:r},{$set:{status:i}});return o.NextResponse.json({message:"Mistakes updated successfully",updated:s.modifiedCount})}catch(e){return console.error("Error updating mistakes:",e),o.NextResponse.json({error:"Failed to update mistakes"},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/mistakes/route",pathname:"/api/mistakes",filename:"route",bundlePath:"app/api/mistakes/route"},resolvedPagePath:"D:\\武欣宇\\大三下\\计算机设计大赛\\StudyPlanner2\\src\\app\\api\\mistakes\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:q,staticGenerationAsyncStorage:x,serverHooks:w}=y,f="/api/mistakes/route";function h(){return(0,a.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:x})}},95456:(e,t,r)=>{r.d(t,{L:()=>o});var n=r(53797),i=r(42023),s=r(75748),a=r(93330);let o={pages:{signIn:"/login"},session:{strategy:"jwt",maxAge:604800},providers:[(0,n.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("请输入邮箱和密码");await (0,s.v)();let t=await a.n.findOne({email:e.email});if(!t)throw Error("用户不存在");if(!await (0,i.compare)(e.password,t.password))throw Error("密码错误");return{id:t._id.toString(),email:t.email,name:t.name}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email,e.name=t.name),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id,e.user.email=t.email,e.user.name=t.name),e)}}},75748:(e,t,r)=>{r.d(t,{Z:()=>l,v:()=>u});var n=r(11185),i=r.n(n);let s=process.env.MONGODB_URI||"mongodb://localhost:27017/studyplanner";if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env");let a=global.mongoose;async function o(){if(a||(a=global.mongoose={conn:null,promise:null}),a.conn)return a.conn;a.promise||(a.promise=i().connect(s,{bufferCommands:!1}).then(e=>a));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}a||(a=global.mongoose={conn:null,promise:null});let u=o,l=o},57369:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),i=r.n(n);let s=new n.Schema({userId:{type:String,required:!0},questionId:{type:n.Schema.Types.ObjectId,ref:"Question",required:!0},category:{type:String,required:!0},wrongAnswer:{type:n.Schema.Types.Mixed,required:!0},wrongCount:{type:Number,default:1},lastWrongDate:{type:Date,default:Date.now},notes:{type:String},status:{type:String,required:!0,enum:["unresolved","reviewing","resolved"],default:"unresolved"}},{timestamps:!0});s.index({userId:1,questionId:1},{unique:!0});let a=i().models.Mistake||i().model("Mistake",s)},5112:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),i=r.n(n);let s=new n.Schema({title:{type:String,required:!0},content:{type:String,required:!0},type:{type:String,required:!0,enum:["choice","multiple","judge","fill","code"]},category:{type:String,required:!0},subcategory:{type:String},difficulty:{type:String,required:!0,enum:["easy","medium","hard"]},options:[{label:{type:String,required:!0},text:{type:String,required:!0}}],answer:{type:n.Schema.Types.Mixed,required:!0},explanation:{type:String,required:!0},tags:[{type:String}]},{timestamps:!0}),a=i().models.Question||i().model("Question",s)},93330:(e,t,r)=>{r.d(t,{n:()=>o});var n=r(11185),i=r.n(n);async function s(){try{if(1===i().connection.readyState&&i().connection.db){let e=(await i().connection.db.collections()).find(e=>"users"===e.collectionName);e&&await e.dropIndexes()}}catch(e){console.error("Error initializing user collection:",e)}}let a=new(i()).Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},createdAt:{type:Date,default:Date.now}});a.index({email:1},{unique:!0}),1===i().connection.readyState&&s();let o=i().models.User||i().model("User",a)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,2023,6016],()=>r(33942));module.exports=n})();